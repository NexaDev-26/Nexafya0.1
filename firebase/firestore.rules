// Firebase Firestore Security Rules
// Copy these rules to Firebase Console > Firestore > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin (must check users collection)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    // Helper function to check if user is courier
    function isCourier() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'COURIER';
    }
    
    // Helper function to check if doctor can verify articles
    function canVerifyArticles() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/doctors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data.canVerifyArticles == true;
    }
    
    // Users collection - users can read/write their own profile, admins can manage all users
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Doctors collection - public read, doctors can write their own profile
    match /doctors/{doctorId} {
      allow read: if true; // Public read for finding doctors
      allow create: if isAuthenticated() && doctorId == request.auth.uid;
      allow update, delete: if isOwner(doctorId);
    }
    
    // Appointments - users can read their own, create new ones
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow delete: if isOwner(resource.data.patientId);
    }
    
    // Health Records - patients can read/write their own
    match /healthRecords/{recordId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.patientId);
    }
    
    // Health Metrics - patients can read/write their own
    match /healthMetrics/{metricId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.patientId);
    }
    
    // Articles - Patients, Couriers, Admins can read; Doctors create; Selected doctors can verify
    match /articles/{articleId} {
      allow read: if true; // Public read for all (patients, couriers, admins)
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.authorId) || isAdmin() || 
                     (canVerifyArticles() && request.resource.data.keys().hasAny(['status', 'verifiedBy', 'verifiedByName', 'verifiedAt', 'verificationNotes', 'rejectionReason']));
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Medicines - public read, authenticated users can create
    match /medicines/{medicineId} {
      allow read: if true; // Public read
      allow create, update, delete: if isAuthenticated();
    }
    
    // Inventory - pharmacy owners can manage their inventory
    match /inventory/{inventoryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Pharmacy Branches - public read, owners can manage
    match /pharmacyBranches/{branchId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.owner_id);
    }
    
    // Prescriptions - enhanced chain of custody (patients, doctors, pharmacies can read)
    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        resource.data.pharmacyId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.doctorId == request.auth.uid ||
        resource.data.pharmacyId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Orders - users can read their own orders
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.patient_id == request.auth.uid || 
        resource.data.pharmacy_id == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.pharmacy_id == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Household Visits - CHWs can manage their visits
    match /householdVisits/{visitId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.chw_id) || isAdmin();
    }
    
    // Subscription Packages - public read, admin can manage
    match /subscriptionPackages/{packageId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Partners - public read, admin can manage
    match /partners/{partnerId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Verifications - authenticated users can read/write
    match /verifications/{verificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // Transactions - users can read their own transactions, recipients can verify
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      // Allow recipients (doctors/pharmacies) to verify/reject payments
      allow update: if isAuthenticated() && (
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Messages - users can read/write their own messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
      allow delete: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
    }
    
    // Doctor Payment Methods - doctors can manage their own, public read for patients
    match /doctorPaymentMethods/{paymentMethodId} {
      allow read: if true; // Public read so patients can see payment methods
      allow create: if isAuthenticated() && request.resource.data.doctorId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.doctorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.doctorId == request.auth.uid;
    }
    
    // Pharmacy Payment Methods - pharmacies can manage their own, public read for customers
    match /pharmacyPaymentMethods/{paymentMethodId} {
      allow read: if true; // Public read so customers can see payment methods
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Article Access - users can read their own access records
    match /articleAccess/{accessId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
    
    // Doctor Reviews - public read, authenticated patients can create/update their own
    match /doctorReviews/{reviewId} {
      allow read: if true; // Public read so patients can see reviews
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }
    
    // NHIF Members - users can read/write their own
    match /nhifMembers/{memberId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Medication Schedules - patients can read/write their own, doctors can read their patients
    match /medicationSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Medication Doses - patients can read/write their own
    match /medicationDoses/{doseId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Audit Logs - only admins can read
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // System can create logs
      allow update, delete: if false; // Logs are immutable
    }
    
    // Notifications - users can read their own
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.recipientRole == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Subscriptions - users can read/write their own (PHARMACY ONLY)
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Trust Tier Configs - Admin manages tier fees and features for doctors/couriers
    match /trustTierConfigs/{configId} {
      allow read: if isAuthenticated(); // All users can see available tiers
      allow write: if isAdmin(); // Only admins can create/update tier configs
    }
    
    // User Tier Assignments - Admin assigns tiers to doctors/couriers with trial period
    match /userTierAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAdmin(); // Only admins can assign tiers
      allow update: if isAdmin(); // Only admins can update tier status or activate after trial
      allow delete: if isAdmin();
    }
    
    // User Bookmarks - users can manage their own bookmarks
    match /userBookmarks/{bookmarkId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Wearable Devices - users can read/write their own
    match /wearableDevices/{deviceId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Suppliers - pharmacy owners can manage their suppliers
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }

    // Purchase records - pharmacy owners can manage
    match /purchaseRecords/{purchaseId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }

    // Consents - patients can manage their own consents
    match /consents/{consentId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.grantedTo == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }

    // Refill reminders - patients can manage their own
    match /refillReminders/{reminderId} {
      allow read: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }
    
    // SOS Alerts - patients create, admins read
    match /sosAlerts/{alertId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
    }
    
    // Symptom Sessions - users can read/write their own
    match /symptomSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.patientId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Family Members - users can manage their own family members
    match /familyMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Referrals - users can read their own referrals, create new ones
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (
        resource.data.referrerId == request.auth.uid ||
        resource.data.referredUserId == request.auth.uid
      );
      allow create: if isAuthenticated();
    }
    
    // Item Groups - pharmacy owners can manage their item groups
    match /itemGroups/{groupId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Item Categories - pharmacy owners can manage their categories
    match /itemCategories/{categoryId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Item Units - pharmacy owners can manage their units
    match /itemUnits/{unitId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Inventory Adjustments - pharmacy owners can manage adjustments
    match /inventoryAdjustments/{adjustmentId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Sales - pharmacy owners can manage their sales
    match /sales/{saleId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Purchase Records - pharmacy owners can manage purchases
    match /purchaseRecords/{purchaseId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Suppliers - pharmacy owners can manage suppliers
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Unit Conversions - pharmacy owners can manage conversions
    match /unitConversions/{conversionId} {
      allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    }
    
    // Platform Settings - only admins can read/write
    match /platformSettings/{settingsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Admin Logs - only admins can read, admins can write
    match /adminLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
    }
    
    // Notifications - users can read their own, admins can create
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAdmin();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Verification Documents - users can read/write their own, admins can read/write all
    match /verificationDocuments/{documentId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // User Verifications - users can read their own, admins can read/write all
    match /userVerifications/{verificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Lab Tests - public read, admin write
    match /labTests/{testId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Lab Partners - public read, admin write
    match /labPartners/{partnerId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Lab Bookings - users can read/write their own, admins can read all
    match /labBookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Lab Results - users can read their own, admins can read/write all
    match /labResults/{resultId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        request.auth.uid in (resource.data.sharedWith || []) ||
        isAdmin()
      );
      allow write: if isAdmin();
    }
    
    // Support Tickets - users can read/write their own, admins can read/write all
    match /supportTickets/{ticketId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Audit Logs - admins only
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if true; // System can write logs
    }
    
    // System Settings - admins only
    match /systemSettings/{settingsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Video Call Signaling - participants can read/write
    match /videoCalls/{callId} {
      allow read, write: if isAuthenticated();
    }
  }
}

