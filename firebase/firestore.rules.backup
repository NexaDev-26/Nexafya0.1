// Firebase Firestore Security Rules
// Copy these rules to Firebase Console > Firestore > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin (must be defined after users collection rule can access it)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Doctors collection - public read, doctors can write their own profile
    match /doctors/{doctorId} {
      allow read: if true; // Public read for finding doctors
      allow create: if isAuthenticated() && doctorId == request.auth.uid;
      allow update, delete: if isOwner(doctorId);
    }
    
    // Appointments - users can read their own, create new ones
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow delete: if isOwner(resource.data.patientId);
    }
    
    // Health Records - patients can read/write their own
    match /healthRecords/{recordId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.patientId);
    }
    
    // Health Metrics - patients can read/write their own
    match /healthMetrics/{metricId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.patientId);
    }
    
    // Articles - public read, authenticated users can create
    match /articles/{articleId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.authorId);
    }
    
    // Medicines - public read, authenticated users can create
    match /medicines/{medicineId} {
      allow read: if true; // Public read
      allow create, update, delete: if isAuthenticated();
    }
    
    // Inventory - pharmacy owners can manage their inventory
    match /inventory/{inventoryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Pharmacy Branches - public read, owners can manage
    match /pharmacyBranches/{branchId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.owner_id);
    }
    
    
    // Orders - users can read their own orders
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.patient_id == request.auth.uid || 
        resource.data.pharmacy_id == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // Household Visits - CHWs can manage their visits
    match /householdVisits/{visitId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.chw_id);
    }
    
    // Subscription Packages - public read, admin can manage
    match /subscriptionPackages/{packageId} {
      allow read: if true; // Public read
      allow write: if isAuthenticated(); // TODO: Add admin role check
    }
    
    // Partners - public read, admin can manage
    match /partners/{partnerId} {
      allow read: if true; // Public read
      allow write: if isAuthenticated(); // TODO: Add admin role check
    }
    
    // Verifications - authenticated users can read/write
    match /verifications/{verificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // Transactions - users can read their own transactions
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); // TODO: Add admin role check
    }
    
    // Messages - users can read/write their own messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.participants
      );
    }
    
    // Doctor Payment Methods - doctors can manage their own, public read for patients
    match /doctorPaymentMethods/{paymentMethodId} {
      allow read: if true; // Public read so patients can see payment methods
      allow create: if isAuthenticated() && request.resource.data.doctorId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.doctorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.doctorId == request.auth.uid;
    }
    
    // Article Access - users can read their own access records
    match /articleAccess/{accessId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.doctorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
    
    // Doctor Reviews - public read, authenticated patients can create/update their own
    match /doctorReviews/{reviewId} {
      allow read: if true; // Public read so patients can see reviews
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }
    
    // NHIF Members - users can read/write their own
    match /nhifMembers/{memberId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Medication Schedules - patients can read/write their own, doctors can read their patients
    match /medicationSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Medication Doses - patients can read/write their own
    match /medicationDoses/{doseId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Audit Logs - only admins can read
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // System can create logs
      allow update, delete: if false; // Logs are immutable
    }
    
    // Notifications - users can read their own
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.recipientRole == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Subscriptions - users can read/write their own
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Wearable Devices - users can read/write their own
    match /wearableDevices/{deviceId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Prescriptions - enhanced chain of custody (patients, doctors, pharmacies can read)
    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        resource.data.pharmacyId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.doctorId == request.auth.uid ||
        resource.data.pharmacyId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Suppliers - pharmacy owners can manage their suppliers
  match /suppliers/{supplierId} {
    allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
    allow update, delete: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
  }

  // Purchase records - pharmacy owners can manage
  match /purchaseRecords/{purchaseId} {
    allow read: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
    allow create: if isAuthenticated() && request.resource.data.pharmacyId == request.auth.uid;
    allow update: if isAuthenticated() && resource.data.pharmacyId == request.auth.uid;
  }

  // Consents - patients can manage their own consents
  match /consents/{consentId} {
    allow read: if isAuthenticated() && (
      resource.data.patientId == request.auth.uid ||
      resource.data.grantedTo == request.auth.uid
    );
    allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
    allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
  }

    // Refill reminders - patients can manage their own
    match /refillReminders/{reminderId} {
      allow read: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.patientId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }
    
    // SOS Alerts - patients create, admins read
    match /sosAlerts/{alertId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
    }
    
    // Symptom Sessions - patients can read/write their own
    match /symptomSessions/{sessionId} {
      allow read: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.patientId == request.auth.uid;
    }
    
    // Family Members - users can manage their own family members
    match /familyMembers/{memberId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }

